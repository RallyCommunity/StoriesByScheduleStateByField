<!DOCTYPE html>
<html>
<head>
    <title>ChartApp</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._getStoryFields()},_getStoryFields:function(){var storyFields=[],modelFactory=Rally.data.ModelFactory.getModel({type:"User Story",success:function(model){Ext.Array.each(model.getFields(),function(field){storyFields.push({field:field.name})}),this._generateFieldComboBox(storyFields)},scope:this})},_generateFieldComboBox:function(fields){var myStore=Ext.create("Rally.data.custom.Store",{pageSize:fields.length,data:fields}),fieldComboBox=Ext.create("Rally.ui.combobox.ComboBox",{store:myStore,displayField:"field",listeners:{beforeselect:function(combobox,records){console.log("Test"),this._generateStoryData(records[0].data.field)},scope:this}});this.add(fieldComboBox)},_generateStoryData:function(selectedField){var lookbackStore=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,fetch:[selectedField,"ScheduleState"],hydrate:["ScheduleState"],filters:[{property:"_TypeHierarchy",operator:"=",value:"HierarchicalRequirement"},{property:"__At",value:"current"},{property:"_ProjectHierarchy",operator:"=",value:this.getContext().getProject().ObjectID}],listeners:{load:function(store,stories){0!==stories.length?this._generateChartDataArray(stories,selectedField):console.log("No stories at all...")},scope:this}})},_generateChartDataArray:function(stories,selectedField){var chartData=[];Ext.Array.each(stories,function(story){var fieldValue=story.get(selectedField),scheduleStateValue=story.get("ScheduleState");void 0===chartData[fieldValue]?(chartData[fieldValue]={},chartData[fieldValue][scheduleStateValue]=1):void 0===chartData[fieldValue][scheduleStateValue]?chartData[fieldValue][scheduleStateValue]=1:chartData[fieldValue][scheduleStateValue]+=1}),this._generateSeries(chartData,selectedField)},_generateSeries:function(chartData,selectedField){var mySeries=[];for(var key in chartData){var tobj={name:"",data:[]},tdata=[0,0,0,0,0,0];tobj.name=key;for(var key2 in chartData[key])"Idea"==key2?tdata[0]+=chartData[key][key2]:"Defined"==key2?tdata[1]+=chartData[key][key2]:"In-Progress"==key2?tdata[2]+=chartData[key][key2]:"Completed"==key2?tdata[3]+=chartData[key][key2]:"Accepted"==key2?tdata[4]+=chartData[key][key2]:tdata[5]+=chartData[key][key2];tobj.data=tdata,mySeries.push(tobj)}this._updateChart(mySeries,selectedField)},_updateChart:function(mySeries,selectedField){void 0!==this.myChart&&this.remove(this.myChart),this._generateChart(mySeries,selectedField)},_generateChart:function(mySeries,selectedField){this.myChart=Ext.create("Rally.ui.chart.Chart",{chartConfig:{chart:{type:"column"},title:{text:"Stories by Schedule State by "+selectedField+" Field"},xAxis:{},yAxis:{min:0,title:{text:"Number of Stories"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:mySeries,categories:["Idea","Defined","In-Progress","Completed","Accepted","Released"]}}),this.add(this.myChart)}});

            Rally.launchApp('CustomApp', {
                name:"ChartApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
